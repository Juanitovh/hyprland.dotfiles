#!/bin/bash

# Cycles through the background images available in current theme

BACKGROUNDS_DIR="$HOME/.local/state/hyprland/current/theme/backgrounds/"
CURRENT_BACKGROUND_LINK="$HOME/.local/state/hyprland/current/background"

# Find all background files
mapfile -d '' -t BACKGROUNDS < <(find -L "$BACKGROUNDS_DIR" -type f -print0 2>/dev/null | sort -z)
TOTAL=${#BACKGROUNDS[@]}

if [[ $TOTAL -eq 0 ]]; then
  notify-send "No background was found for theme" -t 2000
  # Set black background as fallback
  if command -v swww >/dev/null && pgrep -x swww-daemon >/dev/null; then
    pkill -x swww
    setsid uwsm-app -- swww-daemon &
    sleep 0.5
    swww img /dev/null --color 000000 2>/dev/null || swww clear 000000
  elif command -v swaybg >/dev/null; then
    pkill -x swaybg
    setsid uwsm-app -- swaybg --color '#000000' >/dev/null 2>&1 &
  fi
  exit 0
fi

# Get current background from symlink
if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
  CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
else
  # Default to first background if no symlink exists
  CURRENT_BACKGROUND=""
fi

# Find current background index
INDEX=-1
for i in "${!BACKGROUNDS[@]}"; do
  if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
    INDEX=$i
    break
  fi
done

# Get next background (wrap around)
if [[ $INDEX -eq -1 ]]; then
  # Use the first background when no match was found
  NEW_BACKGROUND="${BACKGROUNDS[0]}"
else
  NEXT_INDEX=$(((INDEX + 1) % TOTAL))
  NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
fi

# Set new background symlink
mkdir -p "$(dirname "$CURRENT_BACKGROUND_LINK")"
ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

# Apply wallpaper using available daemon
# Check swaybg first (matches our autostart)
if pgrep -x swaybg >/dev/null || command -v swaybg >/dev/null; then
  # Relaunch swaybg with new background
  pkill -x swaybg
  setsid uwsm-app -- swaybg -i "$CURRENT_BACKGROUND_LINK" -m fill >/dev/null 2>&1 &
elif command -v swww >/dev/null && pgrep -x swww-daemon >/dev/null; then
  swww img "$CURRENT_BACKGROUND_LINK" --transition-type fade
elif command -v hyprpaper >/dev/null; then
  hyprctl hyprpaper preload "$CURRENT_BACKGROUND_LINK"
  hyprctl hyprpaper wallpaper ",$CURRENT_BACKGROUND_LINK"
fi
