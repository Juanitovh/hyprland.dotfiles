#!/bin/bash

# Simple menu system using walker (or rofi as fallback)

menu() {
  local prompt="$1"
  local options="$2"

  if command -v walker >/dev/null; then
    echo -e "$options" | walker --dmenu --width 295 --minheight 1 --maxheight 630 -p "$prompt…" 2>/dev/null
  elif command -v rofi >/dev/null; then
    echo -e "$options" | rofi -dmenu -p "$prompt" -theme-str 'window {width: 400px;}'
  elif command -v wofi >/dev/null; then
    echo -e "$options" | wofi --dmenu -p "$prompt" --width 400
  else
    echo "Error: No menu program found (walker, rofi, or wofi)"
    exit 1
  fi
}

show_system_menu() {
  case $(menu "System" "  Lock\n󰤄  Suspend\n󰜉  Restart\n󰐥  Shutdown") in
  *Lock*) hypr-lock-screen ;; # Use hypr-lock-screen
  *Suspend*) systemctl suspend ;; 
  *Restart*) hypr-reboot ;; 
  *Shutdown*) hypr-shutdown ;; 
  esac
}

show_keybindings_menu() {
  hypr-menu-keybindings
}

show_setup_menu() {
  local options="  Audio\n  Wifi\n󰂯  Bluetooth\n󱐋  Power Profile\n󰍹  Monitors\n  Input\n  DNS\n  Security\n  Config"
  case $(menu "Setup" "$options") in
  *Audio*) hypr-launch-audio ;; 
  *Wifi*) hypr-launch-wifi ;; 
  *Bluetooth*) hypr-launch-bluetooth ;; 
  *Power*) show_setup_power_menu ;; 
  *Monitors*) hypr-launch-terminal -e ${EDITOR:-nano} ~/.config/hypr/monitors.conf && hyprctl reload ;; 
  *Input*) hypr-launch-terminal -e ${EDITOR:-nano} ~/.config/hypr/input.conf && hyprctl reload ;; 
  *DNS*) hypr-launch-terminal -e hypr-setup-dns ;; 
  *Security*) show_setup_security_menu ;; 
  *Config*) show_setup_config_menu ;; 
  esac
}

show_setup_power_menu() {
  profile=$(menu "Power Profile" "$(hypr-powerprofiles-list)")

  if [[ "$profile" == "CNCLD" || -z "$profile" ]]; then
    return
  else
    powerprofilesctl set "$profile"
  fi
}

show_setup_security_menu() {
  case $(menu "Security" "󰈷  Fingerprint\n  Fido2") in
  *Fingerprint*) hypr-launch-terminal -e hypr-setup-fingerprint ;; 
  *Fido2*) hypr-launch-terminal -e hypr-setup-fido2 ;; 
  esac
}

show_setup_config_menu() {
  case $(menu "Config" "  Hyprland\n  Hypridle\n  Hyprlock\n  Hyprsunset\n  Swayosd\n󰌧  Walker\n󰍜  Waybar") in
  *Hyprland*) hyprctl reload ;; 
  *Hypridle*) hypr-restart-hypridle ;; 
  *Hyprlock*) hypr-refresh-hyprlock ;; 
  *Hyprsunset*) hypr-restart-hyprsunset ;; 
  *Swayosd*) hypr-refresh-swayosd ;; 
  *Walker*) hypr-refresh-walker ;; 
  *Waybar*) hypr-refresh-waybar ;; 
  esac
}

show_style_menu() {
  case $(menu "Style" "󰸌  Theme\n  Background\n  Hyprland Config") in
  *Theme*) show_theme_menu ;; 
  *Background*) hypr-theme-bg-next ;; 
  *Hyprland*) hypr-launch-terminal -e ${EDITOR:-nano} ~/.config/hypr/looknfeel.conf && hyprctl reload ;; 
  esac
}

show_install_menu() {
  local options="󰣇  Package\n󰣇  AUR\n  Web App\n  TUI\n  Service\n  Editor\n  Terminal\n󱚤  AI\n󰍲  Windows"
  case $(menu "Install" "$options") in
  *Package*) hypr-launch-terminal -e hypr-pkg-install ;; 
  *AUR*) hypr-launch-terminal -e hypr-pkg-aur-install ;; 
  *Web*) hypr-launch-terminal -e hypr-webapp-install ;; 
  *TUI*) hypr-launch-terminal -e hypr-tui-install ;; 
  *Service*) show_install_service_menu ;; 
  *Editor*) show_install_editor_menu ;; 
  *Terminal*) show_install_terminal_menu ;; 
  *AI*) show_install_ai_menu ;; 
  *Windows*) hypr-launch-terminal -e hypr-windows-vm install ;; 
  esac
}

show_install_service_menu() {
  case $(menu "Install Service" "  Dropbox\n  Tailscale\n  Chromium Account") in
  *Dropbox*) hypr-launch-terminal -e hypr-install-dropbox ;; 
  *Tailscale*) hypr-launch-terminal -e hypr-install-tailscale ;; 
  *Chromium*) hypr-launch-terminal -e hypr-install-chromium-google-account ;; 
  esac
}

show_install_editor_menu() {
  case $(menu "Install Editor" "  VSCode") in
  *VSCode*) hypr-launch-terminal -e hypr-install-vscode ;; 
  esac
}

show_install_terminal_menu() {
  case $(menu "Install Terminal" "  Alacritty") in
  *Alacritty*) hypr-launch-terminal -e hypr-install-terminal "alacritty" ;; 
  esac
}

show_install_ai_menu() {
  echo "AI installation menu not yet implemented" # Placeholder
}

show_remove_menu() {
  local options="󰣇  Package\n  Web App\n  TUI\n󰍲  Windows"
  case $(menu "Remove" "$options") in
  *Package*) hypr-launch-terminal -e hypr-pkg-remove ;; 
  *"Web App"*) 
    hypr-launch-terminal -e "webapp=\$(ls ~/.local/share/applications/*.desktop 2>/dev/null | xargs -n1 basename | sed 's/\.desktop$//' | menu \"Remove Web App\"); if [ -n \"\$webapp\" ]; then hypr-webapp-remove \"\$webapp\"; fi"
    ;; 
  *TUI*) hypr-launch-terminal -e hypr-tui-remove ;; 
  *Windows*) hypr-launch-terminal -e hypr-windows-vm remove ;; 
  esac
}

show_trigger_menu() {
  case $(menu "Trigger" "  Capture\n  Share\n󰔎  Toggle") in
  *Capture*) show_screenshot_menu ;; 
  *Share*) show_share_menu ;; 
  *Toggle*) show_toggle_menu ;; 
  esac
}

show_toggle_menu() {
  case $(menu "Toggle" "󰔎  Nightlight\n󱫖  Idle Lock\n󰍜  Top Bar\n  Transparency\n  Workspace Gaps") in
  *Nightlight*) hypr-toggle-nightlight ;; 
  *Idle*) hypr-toggle-idle ;; 
  *"Top Bar"*) hypr-toggle-waybar ;; 
  *Transparency*) hyprctl dispatch setprop "address:$(hyprctl activewindow -j | jq -r '.address')" opaque toggle ;; 
  *Gaps*) hypr-workspace-toggle-gaps ;; 
  esac
}

show_theme_menu() {
  # Use walker with elephant menus for theme selection
  if command -v walker >/dev/null && command -v elephant >/dev/null; then
    hypr-launch-walker -m menus:hyprthemes --width 800 --minheight 400
  else
    # Fallback to simple list
    THEME=$(find ~/.config/hypr/themes -type f -name "*.conf" 2>/dev/null | xargs -n1 basename | sed 's/\.conf$//' | menu "Select Theme")
    if [ -n "$THEME" ]; then
      hypr-theme-set "$THEME"
    fi
  fi
}

show_screenshot_menu() {
  case $(menu "Screenshot" "  Smart selection with editing\n  Selection to clipboard\n  Full screen") in
  *editing*) hypr-screenshot smart ;; 
  *clipboard*) hypr-screenshot smart clipboard ;; 
  *screen*) hypr-screenshot fullscreen ;; 
  esac
}

show_screenrecord_menu() {
  if pgrep -f "wf-recorder" >/dev/null; then
    pkill -SIGINT wf-recorder
    notify-send "Screen recording stopped"
    exit 0
  fi

  case $(menu "Screen Record" "  Record region\n  Record fullscreen") in
  *region*) 
    geometry=$(slurp 2>/dev/null)
    if [ -n "$geometry" ]; then
      wf-recorder -g "$geometry" -f "$HOME/Videos/recording-$(date +%Y-%m-%d_%H-%M-%S).mp4" &
      notify-send "Recording started" "Press SUPER+ESC to stop"
    fi
    ;; 
  *fullscreen*) 
    wf-recorder -f "$HOME/Videos/recording-$(date +%Y-%m-%d_%H-%M-%S).mp4" &
    notify-send "Recording started" "Press SUPER+ESC to stop"
    ;; 
  esac
}

show_share_menu() {
  case $(menu "Share" "  Share clipboard via LocalSend\n  Share file") in
  *clipboard*) 
    hypr-cmd-share clipboard ;; 
  *file*) 
    hypr-launch-terminal -e "file=\$(zenity --file-selection 2>/dev/null || echo \"\"); if [ -n \"\$file\" ]; then python3 -m http.server 8080 -d \"\$(dirname \"\$file\")\" & notify-send \"File shared\" \"Available at http://localhost:8080/\$(basename \"\$file\")\"; fi"
    ;; 
  esac
}

# Show main menu
show_main_menu() {
  case $(menu "Go" "󰀻  Apps\n󱓞  Trigger\n  Style\n  Setup\n󰉉  Install\n󰭌  Remove\n  Keybindings\n  System\n  About") in # Added About
  *Apps*) walker -p "Launch…" ;; 
  *Trigger*) show_trigger_menu ;; 
  *Style*) show_style_menu ;; 
  *Setup*) show_setup_menu ;; 
  *Install*) show_install_menu ;; 
  *Remove*) show_remove_menu ;; 
  *Keybindings*) show_keybindings_menu ;; 
  *System*) show_system_menu ;; 
  *About*) hypr-launch-about ;; # New
  esac
}

# Main menu routing
case "${1,,}" in
  system) show_system_menu ;; 
  theme) show_theme_menu ;; 
  screenshot) show_screenshot_menu ;; 
  screenrecord) show_screenrecord_menu ;; 
  share) show_share_menu ;; 
  keybindings) show_keybindings_menu ;; 
  setup) show_setup_menu ;; 
  style) show_style_menu ;; 
  install) show_install_menu ;; 
  remove) show_remove_menu ;; 
  trigger) show_trigger_menu ;; 
  toggle) show_toggle_menu ;; 
  about) hypr-launch-about ;; # New
  *) 
    # Default main menu (SUPER+ALT+SPACE)
    show_main_menu
    ;; 
esac